<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <script src="pixi/pixi.min.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
    function Person(condition,x,y,infect,infectedTime){
    	this.condition=condition;
    	this.x=x;
    	this.y=y;
    	this.infect=infect;
    	this.infectedTime=infectedTime;
    	this.time=0;
    }
    Person.prototype.progress=function(){
    	if(this.condition==1){
			this.time++;
			//console.log(this.infectedTime);
			if(this.time>=this.infectedTime){
				//console.log("hello i am a stupid broken computer");
				this.condition=2;
			}
		}
    }
    Person.prototype.move2=function(speed,bX,bY,bW,bH,p,socialDistance){
    	let angle=2*Math.PI*Math.random();
		let radius=Math.random();
		let moveX=speed*radius*Math.cos(angle);
		let moveY=speed*radius*Math.sin(angle);
		let num=1;
		for(let i=0;i<p.length;i++){
			if(!(this==p[i])){
				if(this.getDistance(p[i])<=socialDistance){
					num++;
					let deltaX=(p[i].x-this.x);
					let deltaY=(p[i].y-this.y);
					let m = this.mag(deltaX,deltaY);
					if(m > 0){
						moveX+=-deltaX/m*speed;
						moveY+=-deltaY/m*speed;
					}else{
						moveX+=speed*Math.cos(angle);
						moveY+=speed*Math.sin(angle);
					}
				}
			}
		}
		moveX/=num;
		moveY/=num;
		let ta = Math.tan(angle);
		if((this.x+moveX)<bX){
			moveX=bX-this.x;
			moveY=(bX-this.x)*ta;
		}
		if((this.y+moveY)<bY){
			moveY=bY-this.y;
			moveX=(bX-this.x)/ta;
		}
		if((this.x+moveX)>(bX+bW)){
			moveX=bX+bW-this.x;
			moveY=(bX+bW-this.x)*ta;
		}
		if((this.y+moveY)>(bY+bH)){
			moveY=bY+bH-this.y;
			moveX=(bY+bH-this.y)/ta;
		}
		if(Math.abs(moveY)>speed*radius){
			moveY=0;
		}
		if(Math.abs(moveX)>speed*radius){
			moveX=0;
		}
		this.x+=moveX;
		this.y+=moveY;
		if(this.x>(bX+bW)){
			this.x=bX+bW;
		}
		if(this.x<bX){
			this.x=bX;
		}
		if(this.y>(bY+bH)){
			this.y=bY+bH;
		}
		if(this.y<bY){
			this.y=bY;
		}
    }
    Person.prototype.mag=function(x,y){
    	return Math.sqrt(x*x+y*y);
    }
    Person.prototype.move=function(speed,bX,bY,bW,bH){
    	let angle=2*Math.PI*Math.random();
		let radius=Math.random();
		let moveX=speed*radius*Math.cos(angle);
		let moveY=speed*radius*Math.sin(angle);
		if((this.x+moveX)<bX){
			moveX=bX-this.x;
			moveY=(bX-this.x)*Math.tan(angle);
		}
		if((this.y+moveY)<bY){
			moveY=bY-this.y;
			moveX=(bX-this.x)/Math.tan(angle);
		}
		if((this.x+moveX)>(bX+bW)){
			moveX=bX+bW-this.x;
			moveY=(bX+bW-this.x)*Math.tan(angle);
		}
		if((this.y+moveY)>(bY+bH)){
			moveY=bY+bH-this.y;
			moveX=(bY+bH-this.y)/Math.tan(angle);
		}
		if(Math.abs(moveY)>speed*radius){
			moveY=0;
		}
		if(Math.abs(moveX)>speed*radius){
			moveX=0;
		}
		this.x+=moveX;
		this.y+=moveY;
		if(this.x>(bX+bW)){
			this.x=bX+bW;
		}
		if(this.x<bX){
			this.x=bX;
		}
		if(this.y>(bY+bH)){
			this.y=bY+bH;
		}
		if(this.y<bY){
			this.y=bY;
		}
    }
    Person.prototype.create=function(g,size){
    	if(this.condition==0){
    		g.beginFill(0x0000FF);
		}else if(this.condition==1){
			g.lineStyle(1,0xFF0000,1);
			g.drawCircle(this.x,this.y,this.infect);
			g.beginFill(0xFF0000);
		}else if(this.condition==2){
			g.beginFill(0x000000);
		}
		g.lineStyle(1,0x000000,0);
		g.drawCircle(this.x,this.y,size);
		g.endFill();
    }
    Person.prototype.getDistance=function(p){
    	return this.mag(p.x-this.x,p.y-this.y);
    }
    Person.prototype.spread=function(p){
    	if(this.condition==1){
			for(let i=0;i<p.length;i++){
				if(this.getDistance(p[i])<=this.infect){
					if(p[i].condition==0){
						p[i].condition=1;
					}
				}
			}
		}
    }
    function Community(x,y,w,h,size,speed,infect,infectedTime){
    	this.infect=infect;
    	this.speed=speed;
    	this.infectedTime=infectedTime;
    	this.x=x;
    	this.y=y;
    	this.w=w;
    	this.h=h;
    	this.p=[];
    	this.p.push(new Person(1,this.x+Math.random()*this.w,this.y+Math.random()*this.h,this.infect,this.infectedTime));
    	for(let i=0;i<size-1;i++){
			this.p.push(new Person(0,this.x+Math.random()*this.w,this.y+Math.random()*this.h,this.infect,this.infectedTime));
    	}
    	this.time=0;
    }
    Community.prototype.drawMe=function(g,t,size){
    	for(let i=0;i<app.stage.children.length;i++){
    		app.stage.removeChild(app.stage.getChildAt(0));
    	}
    	g.clear();
    	g.lineStyle(1,0x000000,1);
    	g.drawRect(this.x,this.y,this.w,this.h);
    	for(let i=0;i<this.p.length;i++){
    		this.p[i].create(g,size);
    	}
    	t.text=this.time+"";
    	t.position.set(20,20);
    	app.stage.addChild(g);
    	app.stage.addChild(t);
    }
    Community.prototype.update=function(){
    	for(let i=0;i<this.p.length;i++){
			this.p[i].progress();
			if(this.time >= 300.0){
				this.p[i].move2(this.speed,this.x,this.y,this.w,this.h,this.p,15.0);
			}else{
				this.p[i].move(this.speed,this.x,this.y,this.w,this.h);
			}
		}
		for(let i=0;i<this.p.length;i++){
			this.p[i].spread(this.p);
		}
		this.time++;
    }
    let app = new PIXI.Application({width: 800, height: 800});
    document.body.appendChild(app.view);
    app.renderer.backgroundColor=0xFFFFFF;
	let c=new Community(100,100,600,600,400,15.0,7.0,100);
	let g=new PIXI.Graphics();
	let t=new PIXI.Text();
	function animate(){
    	requestAnimationFrame(animate);
    	c.drawMe(g,t,3);
    	c.update();
    }
    animate();
  </script>
</body>
</html>
