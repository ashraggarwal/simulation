<!doctype html>
<html>
<form>
	<label for="size">Size of Population:</label><br>
	<input type="text" id="size" name="size" value=1000><br>
	<label for="speed">Speed of Person:</label><br>
	<input type="text" id="speed" name="speed" value=10.0><br>
	<label for="infect">Infection Spread Radius:</label><br>
	<input type="text" id="infect" name="infect" value=7.0><br>
	<label for="infectedTime">Duration of Infection:</label><br>
	<input type="text" id="infectedTime" name="infectedTime" value=100><br>
	<label for="deathRate">Death Rate:</label><br>
	<input type="text" id="deathRate" name="deathRate" value=0.08><br>
	<p></p>
	<input type="button" onclick="toggleSocialDistancing()" value="Turn Social Distancing On" id="toggleSocialDistance">
	<p></p>
	<div id="myDiv1">
		<label for="startSocialDistance">Time to Begin Social Distancing:</label><br>
		<input type="text" id="startSocialDistance" name="startSocialDistance" value=200><br>
		<label for="socialDistance">Recommended Distance between People:</label><br>
		<input type="text" id="socialDistance" name="socialDistance" value=13.0><br>
	</div>
	<p></p>
	<input type="button" onclick="toggleQuarantining()" value="Turn Quarantine On" id="toggleQuarantine">
	<p></p>
	<div id="myDiv2">
		<label for="startQuarantine">Time to Start Quarantine:</label><br>
		<input type="text" id="startQuarantine" name="startQuarantine" value=200><br>
		<label for="symptomRate">Rate of Quarantine Among Infected:</label><br>
		<input type="text" id="symptomRate" name="symptomRate" value=0.20><br>
		<label for="moveTime">Time between Infection and Quarantine:</label><br>
		<input type="text" id="moveTime" name="moveTime" value=10><br>
		<label for="hospitalCapacity">Hospital Capacity:</label><br>
		<input type="text" id="hospitalCapacity" name="hospitalCapacity" value=20><br>
	</div>
	<p></p>
	<input type="button" onclick="startSimulation()" value="Start Simulation" id="start">
	<p></p>
	<p>Key:<br>Blue = Untouched by the virus<br>Red = Infected Spreading the Virus<br>Orange = Infected and Quarantined<br>Pink = Survived and No Longer Infected<br>Black = Dead<br>Quarantine and Morgue are both on the left side of the screen</p>
	<style>
	#myDiv1{
		display:none;
	}
	#myDiv2{
		display:none;
	}
	</style>
</form>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
</head>
  <script src="pixi/pixi.min.js"></script>
<body>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
    let socialDistancing=false;
    let quarantining=false;
    function toggleSocialDistancing(){
    	socialDistancing=!socialDistancing;
    	let x=document.getElementById("myDiv1");
    	let y=document.getElementById("toggleSocialDistance");
    	if(y.value=="Turn Social Distancing On"){
    		y.value="Turn Social Distancing Off";
    	}else{
    		y.value="Turn Social Distancing On";
    	}
    	if(x.style.display=="none"||x.style.display==""){
    		x.style.display="block";
    	}else{
    		x.style.display="none";
    	}
    }
    function toggleQuarantining(){
    	quarantining=!quarantining;
    	let x=document.getElementById("myDiv2");
    	let y=document.getElementById("toggleQuarantine");
    	if(y.value=="Turn Quarantine On"){
    		y.value="Turn Quarantine Off";
    	}else{
    		y.value="Turn Quarantine On";
    	}
    	if(x.style.display=="none"||x.style.display==""){
    		x.style.display="block";
    	}else{
    		x.style.display="none";
    	}
    }
    function Person(condition,x,y,infect,infectedTime){
    	this.condition=condition;
    	this.x=x;
    	this.y=y;
    	this.infect=infect;
    	this.infectedTime=infectedTime;
    	this.time=0;
    	this.symptoms=false;
    	this.quarantined=false;
    	this.symptomTime=0;
    	this.alive=true;
    }
    Person.prototype.progress=function(deathRate,moveTime,morgueX,morgueY,hospitalX,hospitalY,centerX,centerY,hospitalFull,quarantine){
    	if(this.condition==1){
			this.time++;
			if(this.symptoms==true){
				this.symptomTime++;
			}
			if(this.symptoms&&this.symptomTime>=moveTime&&!this.quarantined&&!hospitalFull&&quarantine){
				this.quarantined=true;
				this.x=hospitalX;
				this.y=hospitalY;
			}
			//console.log(this.infectedTime);
			if(this.time>=this.infectedTime){
				this.symptoms=false;
				this.condition=2;
				if(this.quarantined){
					this.x=centerX;
					this.y=centerY;
					this.quarantined=false;
				}
				if(Math.random()<deathRate){
					this.alive=false;
					this.x=morgueX;
					this.y=morgueY;
				}
			}
		}
    }
    Person.prototype.move2=function(speed,bX,bY,bW,bH,p,socialDistance){
    	if(this.alive&&!this.quarantined){
			let angle=2*Math.PI*Math.random();
			let radius=Math.random();
			let moveX=speed*radius*Math.cos(angle);
			let moveY=speed*radius*Math.sin(angle);
			let num=1;
			for(let i=0;i<p.length;i++){
				if(!(this==p[i])&&p[i].alive&&!p[i].quarantined){
					if(this.getDistance(p[i])<=socialDistance){
						num++;
						let deltaX=(p[i].x-this.x);
						let deltaY=(p[i].y-this.y);
						let m = this.mag(deltaX,deltaY);
						if(m > 0){
							moveX+=-deltaX/m*speed;
							moveY+=-deltaY/m*speed;
						}else{
							moveX+=speed*Math.cos(angle);
							moveY+=speed*Math.sin(angle);
						}
					}
				}
			}
			moveX/=num;
			moveY/=num;
			let ta = Math.tan(angle);
			if((this.x+moveX)<bX){
				moveX=bX-this.x;
				moveY=(bX-this.x)*ta;
			}
			if((this.y+moveY)<bY){
				moveY=bY-this.y;
				moveX=(bX-this.x)/ta;
			}
			if((this.x+moveX)>(bX+bW)){
				moveX=bX+bW-this.x;
				moveY=(bX+bW-this.x)*ta;
			}
			if((this.y+moveY)>(bY+bH)){
				moveY=bY+bH-this.y;
				moveX=(bY+bH-this.y)/ta;
			}
			if(Math.abs(moveY)>speed*radius){
				moveY=0;
			}
			if(Math.abs(moveX)>speed*radius){
				moveX=0;
			}
			this.x+=moveX;
			this.y+=moveY;
			if(this.x>(bX+bW)){
				this.x=bX+bW;
			}
			if(this.x<bX){
				this.x=bX;
			}
			if(this.y>(bY+bH)){
				this.y=bY+bH;
			}
			if(this.y<bY){
				this.y=bY;
			}
		}
    }
    Person.prototype.mag=function(x,y){
    	return Math.sqrt(x*x+y*y);
    }
    Person.prototype.move=function(speed,bX,bY,bW,bH){
    	if(this.alive&&!this.quarantined){
			let angle=2*Math.PI*Math.random();
			let radius=Math.random();
			let moveX=speed*radius*Math.cos(angle);
			let moveY=speed*radius*Math.sin(angle);
			if((this.x+moveX)<bX){
				moveX=bX-this.x;
				moveY=(bX-this.x)*Math.tan(angle);
			}
			if((this.y+moveY)<bY){
				moveY=bY-this.y;
				moveX=(bX-this.x)/Math.tan(angle);
			}
			if((this.x+moveX)>(bX+bW)){
				moveX=bX+bW-this.x;
				moveY=(bX+bW-this.x)*Math.tan(angle);
			}
			if((this.y+moveY)>(bY+bH)){
				moveY=bY+bH-this.y;
				moveX=(bY+bH-this.y)/Math.tan(angle);
			}
			if(Math.abs(moveY)>speed*radius){
				moveY=0;
			}
			if(Math.abs(moveX)>speed*radius){
				moveX=0;
			}
			this.x+=moveX;
			this.y+=moveY;
			if(this.x>(bX+bW)){
				this.x=bX+bW;
			}
			if(this.x<bX){
				this.x=bX;
			}
			if(this.y>(bY+bH)){
				this.y=bY+bH;
			}
			if(this.y<bY){
				this.y=bY;
			}
		}
    }
    Person.prototype.create=function(g,size){
    	if(this.condition==0){
    		g.beginFill(0x0000FF);
		}else if(this.condition==1){
			if(!this.quarantined){
				g.lineStyle(1,0xFF0000,1);
				g.drawCircle(this.x,this.y,this.infect);
				g.beginFill(0xFF0000);
			}else{
				g.beginFill(0xFF5000);
			}
		}else if(this.condition==2){
			if(this.alive){
				g.beginFill(0xFF00FF);
			}else{
				g.beginFill(0x000000);
			}
		}
		g.lineStyle(1,0x000000,0);
		g.drawCircle(this.x,this.y,size);
		g.endFill();
    }
    Person.prototype.getDistance=function(p){
    	return this.mag(p.x-this.x,p.y-this.y);
    }
    Person.prototype.spread=function(p,symptomRate){
    	if(!this.quarantined){
			if(this.condition==1){
				for(let i=0;i<p.length;i++){
					if(this.getDistance(p[i])<=this.infect){
						if(p[i].condition==0){
							p[i].condition=1;
							if(Math.random()<symptomRate){
								p[i].symptoms=true;
							}
						}
					}
				}
			}
		}
    }
    function Community(x,y,w,h,morgueX,morgueY,hospitalX,hospitalY,graphX,graphY,graphW,graphH,size,speed,infect,infectedTime,doSocialDistance,startSocialDistance,socialDistance,quarantine,startQuarantine,moveTime,hospitalCapacity,deathRate,symptomRate){
    	this.infect=infect;
    	this.speed=speed;
    	this.size=size;
    	this.infectedTime=infectedTime;
    	this.x=x;
    	this.y=y;
    	this.w=w;
    	this.h=h;
    	this.p=[];
    	this.p.push(new Person(1,this.x+Math.random()*this.w,this.y+Math.random()*this.h,this.infect,this.infectedTime));
    	for(let i=0;i<size-1;i++){
			this.p.push(new Person(0,this.x+Math.random()*this.w,this.y+Math.random()*this.h,this.infect,this.infectedTime));
    	}
    	this.time=0;
    	this.socialDistance=socialDistance;
    	this.startSocialDistance=startSocialDistance;
    	this.quarantine=quarantine;
    	this.startQuarantine=startQuarantine;
    	this.moveTime=moveTime;
    	this.hospitalCapacity=hospitalCapacity;
    	this.deathRate=deathRate;
    	this.morgueX=morgueX;
    	this.morgueY=morgueY;
    	this.hospitalX=hospitalX;
    	this.hospitalY=hospitalY;
    	this.symptomRate=symptomRate;
    	this.graphX=graphX;
    	this.graphY=graphY;
    	this.graphW=graphW;
    	this.graphH=graphH;
    	this.states=[];
    	this.states.push([this.size,0,0,0,0]);
    	this.doSocialDistance=doSocialDistance;
    }
    Community.prototype.drawMe=function(g,t,t1,t2,size){
    	for(let i=app.stage.children.length-1;i>=0;i--){
    		app.stage.removeChild(app.stage.getChildAt(i));
    	}
    	g.clear();
    	g.lineStyle(1,0x000000,1);
    	g.drawRect(this.x,this.y,this.w,this.h);
    	for(let i=0;i<this.p.length;i++){
    		this.p[i].create(g,size);
    	}
    	t.text=this.time+"";
    	t.position.set(20,20);
    	if(this.quarantine){
			t1.text=this.numberHospital();
			t1.position.set(this.hospitalX-20,this.hospitalY+20);
    	}
    	t2.text=this.numberDead();
    	t2.position.set(this.morgueX-20,this.morgueY+20);
    	this.graph(g);
    	app.stage.addChild(g);
    	app.stage.addChild(t);
    	app.stage.addChild(t1);
    	app.stage.addChild(t2);
    }
    Community.prototype.numberSpreading=function(){
    	let num=0;
    	for(let i=0;i<this.p.length;i++){
    		if(!this.p[i].quarantined&&this.p[i].condition==1){
    			num++;
    		}
    	}
    	return num;
    }
    Community.prototype.numberHospital=function(){
    	let num=0;
    	for(let i=0;i<this.p.length;i++){
    		if(this.p[i].quarantined){
    			num++;
    		}
    	}
    	return num;
    }
    Community.prototype.numberDead=function(){
    	let num=0;
    	for(let i=0;i<this.p.length;i++){
    		if(!this.p[i].alive){
    			num++;
    		}
    	}
    	return num;
    }
    Community.prototype.numberImmune=function(){
    	let num=0;
    	for(let i=0;i<this.p.length;i++){
    		if(this.p[i].condition==2&&this.p[i].alive){
    			num++;
    		}
    	}
    	return num;
    }
    Community.prototype.numberUntouched=function(){
    	let num=0;
    	for(let i=0;i<this.p.length;i++){
    		if(this.p[i].condition==0){
    			num++;
    		}
    	}
    	return num;
    }
    Community.prototype.graph=function(g){
    	for(let i=0;i<this.states.length;i++){
    		let h3=this.states[i][0]*this.graphH/this.size;
    		let h1=this.states[i][1]*this.graphH/this.size;
    		let h4=this.states[i][2]*this.graphH/this.size;
    		let h2=this.states[i][3]*this.graphH/this.size;
    		let h5=this.states[i][4]*this.graphH/this.size;
    		let w=this.graphW/this.states.length;
    		let x=i*w+this.graphX;
    		g.beginFill(0xFF0000);
    		g.drawRect(x,this.graphY+this.graphH-h1,w,h1);
    		g.endFill();
    		g.beginFill(0xFF00FF);
    		g.drawRect(x,this.graphY+this.graphH-h2-h1,w,h2);
    		g.endFill();
    		g.beginFill(0x0000FF);
    		g.drawRect(x,this.graphY+this.graphH-h3-h2-h1,w,h3);
    		g.endFill();
    		g.beginFill(0xFF5000);
    		g.drawRect(x,this.graphY+this.graphH-h4-h3-h2-h1,w,h4);
    		g.endFill();
    		g.beginFill(0x000000);
    		g.drawRect(x,this.graphY+this.graphH-h5-h4-h3-h2-h1,w,h5);
    		g.endFill();
    		if((this.doSocialDistance&&i==this.startSocialDistance)||(this.quarantine&&i==this.startQuarantine)){
    			g.beginFill(0xFFFF00);
    			g.drawRect(x,this.graphY,1,this.graphH);
    			g.endFill();
    		}
    	}
    }
    Community.prototype.done=function(){
    	for(let i=0;i<this.p.length;i++){
    		if(this.p[i].condition==1){
    			return false;
    		}
    	}
    	return true;
    }
    Community.prototype.update=function(){
    	for(let i=0;i<this.p.length;i++){
			this.p[i].progress(this.deathRate,this.moveTime,this.morgueX,this.morgueY,this.hospitalX,this.hospitalY,this.x+this.w/2,this.y+this.h/2,(this.hospitalCapacity<=this.numberHospital()),this.quarantine&&(this.time>=this.startQuarantine));
			if(this.time>=this.startSocialDistance&&this.doSocialDistance){
				this.p[i].move2(this.speed,this.x,this.y,this.w,this.h,this.p,this.socialDistance);
			}else{
				this.p[i].move(this.speed,this.x,this.y,this.w,this.h);
			}
		}
		for(let i=0;i<this.p.length;i++){
			this.p[i].spread(this.p,this.symptomRate);
		}
		this.states.push([this.numberUntouched(),this.numberSpreading(),this.numberHospital(),this.numberImmune(),this.numberDead()]);
		this.time++;
    }
    let c;
    function startSimulation(){
    	let socialDistance1=0;
    	let startSocialDistance1=0;
    	let startQuarantine1=0;
    	let moveTime1=0;
    	let hospitalCapacity1=0;
    	let symptomRate1=0;
    	if(socialDistancing){
    		socialDistance1=document.getElementById("socialDistance").value;
    		startSocialDistance1=document.getElementById("startSocialDistance").value;
    	}
    	if(quarantining){
    		startQuarantine1=document.getElementById("startQuarantine").value;
    		moveTime1=document.getElementById("moveTime").value;
    		hospitalCapacity1=document.getElementById("hospitalCapacity").value;
    		symptomRate1=document.getElementById("symptomRate").value;
    	}
    	c=new Community(100,100,600,600,50,300,50,500,800,100,400,400,document.getElementById("size").value,document.getElementById("speed").value,document.getElementById("infect").value,document.getElementById("infectedTime").value,socialDistancing,startSocialDistance1,socialDistance1,quarantining,startQuarantine1,moveTime1,hospitalCapacity1,document.getElementById("deathRate").value,symptomRate1);
    	animate();
    }
    let app = new PIXI.Application({width: 1300, height: 800});
    document.body.appendChild(app.view);
    app.renderer.backgroundColor=0xFFFFFF;
	//c=new Community(100,100,600,600,50,300,50,500,800,100,400,400,1000,10.0,7.0,100,true,200,13.0,true,200,10,20,0.08,0.20);
	let g=new PIXI.Graphics();
	let t=new PIXI.Text();
	let t1=new PIXI.Text();
	let t2=new PIXI.Text();
	let button=new PIXI.Sprite();
	button.buttonMode=true;
	function animate(){
		if(c&&!c.done()){
			requestAnimationFrame(animate);
			c.drawMe(g,t,t1,t2,3);
			c.update();
    	}else if(c&&c.done()){
    		c.drawMe(g,t,t1,t2,3);
    	}
    }
  </script>
</body>
</html>
